name: Secret Provider SetSecret Tests
on: [pull_request, workflow_dispatch]
permissions:
  contents: read
  issues: none
  pull-requests: none
concurrency:
  group: duplicati-ci-secretprovidertests
  cancel-in-progress: false
jobs:
  check_secrets:
    runs-on: ubuntu-latest
    outputs:
      aws_secrets_available: "${{ steps.check_aws.outputs.available }}"
      azure_secrets_available: "${{ steps.check_azure.outputs.available }}"
      gcs_secrets_available: "${{ steps.check_gcs.outputs.available }}"
      hcvault_secrets_available: "${{ steps.check_hcvault.outputs.available }}"
    steps:
      - id: check_aws
        name: Check AWS secrets
        shell: bash
        run: |
          echo "Starting AWS secrets check..."
          if [[ -n "${{ secrets.DUPLICATI_TEST_AWSSM_ACCESS_KEY }}" ]] && \
            [[ -n "${{ secrets.DUPLICATI_TEST_AWSSM_SECRET_KEY }}" ]] && \
            [[ -n "${{ secrets.DUPLICATI_TEST_AWSSM_REGION }}" ]] && \
            [[ -n "${{ secrets.DUPLICATI_TEST_AWSSM_SECRET_NAME }}" ]]; then
            echo "All AWS secrets found"
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "Missing some AWS secrets"
            echo "available=false" >> $GITHUB_OUTPUT
          fi
          echo "AWS check completed"
      - id: check_azure
        name: Check Azure secrets
        shell: bash
        run: |
          echo "Starting Azure secrets check..."
          if [[ -n "${{ secrets.DUPLICATI_TEST_AZKV_VAULT_URI }}" ]] && \
            [[ -n "${{ secrets.DUPLICATI_TEST_AZKV_TENANT_ID }}" ]] && \
            [[ -n "${{ secrets.DUPLICATI_TEST_AZKV_CLIENT_ID }}" ]] && \
            [[ -n "${{ secrets.DUPLICATI_TEST_AZKV_CLIENT_SECRET }}" ]]; then
            echo "All Azure secrets found"
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "Missing some Azure secrets"
            echo "available=false" >> $GITHUB_OUTPUT
          fi
          echo "Azure check completed"
      - id: check_gcs
        name: Check GCS secrets
        shell: bash
        run: |
          echo "Starting GCS secrets check..."
          if [[ -n "${{ secrets.DUPLICATI_TEST_GCS_PROJECT_ID }}" ]] && \
            [[ -n "${{ secrets.DUPLICATI_TEST_GCS_ACCESS_TOKEN }}" ]] && \
            [[ -n "${{ secrets.DUPLICATI_TEST_GCS_SECRET_ID }}" ]]; then
            echo "All GCS secrets found"
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "Missing some GCS secrets"
            echo "available=false" >> $GITHUB_OUTPUT
          fi
          echo "GCS check completed"
      - id: check_hcvault
        name: Check HashiCorp Vault secrets
        shell: bash
        run: |
          echo "Starting HashiCorp Vault secrets check..."
          if [[ -n "${{ secrets.DUPLICATI_TEST_HCV_HOST }}" ]] && \
            [[ -n "${{ secrets.DUPLICATI_TEST_HCV_TOKEN }}" ]] && \
            [[ -n "${{ secrets.DUPLICATI_TEST_HCV_SECRETS }}" ]]; then
            echo "All HashiCorp Vault secrets found"
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "Missing some HashiCorp Vault secrets"
            echo "available=false" >> $GITHUB_OUTPUT
          fi
          echo "HashiCorp Vault check completed"
      - name: Debug Output
        shell: bash
        run: |
          echo "AWS Available: ${{ steps.check_aws.outputs.available }}"
          echo "Azure Available: ${{ steps.check_azure.outputs.available }}"
          echo "GCS Available: ${{ steps.check_gcs.outputs.available }}"
          echo "HashiCorp Vault Available: ${{ steps.check_hcvault.outputs.available }}"

  test_fileprovider:
    name: File Provider SetSecret Tests
    runs-on: "${{ matrix.os }}"
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
          - macos-latest
    steps:
      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.x
      - name: Checkout source
        uses: actions/checkout@v4
      - name: Restore NuGet dependencies
        run: >-
          dotnet restore
          Duplicati.slnx
      - name: Build project
        run: >-
          dotnet build --no-restore
          Duplicati.slnx
      - name: Run FileProvider SetSecret tests
        run: >-
          dotnet test --no-build --filter="ClassName~SecretProviderSetSecretTests&Name~FileProvider_SetSecret_WritesToFile"
          --logger:"console;verbosity=detailed"
          Duplicati.slnx

  test_aws:
    needs: check_secrets
    if: needs.check_secrets.outputs.aws_secrets_available == 'true'
    name: AWS Secret Provider SetSecret Tests
    runs-on: "${{ matrix.os }}"
    strategy:
      max-parallel: 1
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
          - macos-latest
    steps:
      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.x
      - name: Checkout source
        uses: actions/checkout@v4
      - name: Restore NuGet dependencies
        run: >-
          dotnet restore
          Duplicati.slnx
      - name: Build project
        run: >-
          dotnet build --no-restore
          Duplicati.slnx
      - name: Run AWS Secret Provider SetSecret tests
        env:
          DUPLICATI_TEST_AWSSM_ACCESS_KEY: "${{ secrets.DUPLICATI_TEST_AWSSM_ACCESS_KEY }}"
          DUPLICATI_TEST_AWSSM_SECRET_KEY: "${{ secrets.DUPLICATI_TEST_AWSSM_SECRET_KEY }}"
          DUPLICATI_TEST_AWSSM_REGION: "${{ secrets.DUPLICATI_TEST_AWSSM_REGION }}"
          DUPLICATI_TEST_AWSSM_SECRET_NAME: "${{ secrets.DUPLICATI_TEST_AWSSM_SECRET_NAME }}"
        run: >-
          dotnet test --no-build --filter="ClassName~SecretProviderSetSecretTests&Name~AwsProvider_SetSecret_Works"
          --logger:"console;verbosity=detailed"
          Duplicati.slnx

  test_azure:
    needs: check_secrets
    if: needs.check_secrets.outputs.azure_secrets_available == 'true'
    name: Azure Secret Provider SetSecret Tests
    runs-on: "${{ matrix.os }}"
    strategy:
      max-parallel: 1
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
          - macos-latest
    steps:
      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.x
      - name: Checkout source
        uses: actions/checkout@v4
      - name: Restore NuGet dependencies
        run: >-
          dotnet restore
          Duplicati.slnx
      - name: Build project
        run: >-
          dotnet build --no-restore
          Duplicati.slnx
      - name: Run Azure Secret Provider SetSecret tests
        env:
          DUPLICATI_TEST_AZKV_VAULT_URI: "${{ secrets.DUPLICATI_TEST_AZKV_VAULT_URI }}"
          DUPLICATI_TEST_AZKV_TENANT_ID: "${{ secrets.DUPLICATI_TEST_AZKV_TENANT_ID }}"
          DUPLICATI_TEST_AZKV_CLIENT_ID: "${{ secrets.DUPLICATI_TEST_AZKV_CLIENT_ID }}"
          DUPLICATI_TEST_AZKV_CLIENT_SECRET: "${{ secrets.DUPLICATI_TEST_AZKV_CLIENT_SECRET }}"
        run: >-
          dotnet test --no-build --filter="ClassName~SecretProviderSetSecretTests&Name~AzureProvider_SetSecret_Works"
          --logger:"console;verbosity=detailed"
          Duplicati.slnx

  test_gcs:
    needs: check_secrets
    if: needs.check_secrets.outputs.gcs_secrets_available == 'true'
    name: GCS Secret Provider SetSecret Tests
    runs-on: "${{ matrix.os }}"
    strategy:
      max-parallel: 1
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
          - macos-latest
    steps:
      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.x
      - name: Checkout source
        uses: actions/checkout@v4
      - name: Restore NuGet dependencies
        run: >-
          dotnet restore
          Duplicati.slnx
      - name: Build project
        run: >-
          dotnet build --no-restore
          Duplicati.slnx
      - name: Run GCS Secret Provider SetSecret tests
        env:
          DUPLICATI_TEST_GCS_PROJECT_ID: "${{ secrets.DUPLICATI_TEST_GCS_PROJECT_ID }}"
          DUPLICATI_TEST_GCS_ACCESS_TOKEN: "${{ secrets.DUPLICATI_TEST_GCS_ACCESS_TOKEN }}"
          DUPLICATI_TEST_GCS_SECRET_ID: "${{ secrets.DUPLICATI_TEST_GCS_SECRET_ID }}"
        run: >-
          dotnet test --no-build --filter="ClassName~SecretProviderSetSecretTests&Name~GcsProvider_SetSecret_Works"
          --logger:"console;verbosity=detailed"
          Duplicati.slnx

  test_hcvault:
    needs: check_secrets
    if: needs.check_secrets.outputs.hcvault_secrets_available == 'true'
    name: HashiCorp Vault Secret Provider SetSecret Tests
    runs-on: "${{ matrix.os }}"
    strategy:
      max-parallel: 1
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
          - macos-latest
    steps:
      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.x
      - name: Checkout source
        uses: actions/checkout@v4
      - name: Restore NuGet dependencies
        run: >-
          dotnet restore
          Duplicati.slnx
      - name: Build project
        run: >-
          dotnet build --no-restore
          Duplicati.slnx
      - name: Run HashiCorp Vault Secret Provider SetSecret tests
        env:
          DUPLICATI_TEST_HCV_HOST: "${{ secrets.DUPLICATI_TEST_HCV_HOST }}"
          DUPLICATI_TEST_HCV_TOKEN: "${{ secrets.DUPLICATI_TEST_HCV_TOKEN }}"
          DUPLICATI_TEST_HCV_MOUNT: "${{ secrets.DUPLICATI_TEST_HCV_MOUNT }}"
          DUPLICATI_TEST_HCV_SECRETS: "${{ secrets.DUPLICATI_TEST_HCV_SECRETS }}"
        run: >-
          dotnet test --no-build --filter="ClassName~SecretProviderSetSecretTests&Name~HcVaultProvider_SetSecret_Works"
          --logger:"console;verbosity=detailed"
          Duplicati.slnx
